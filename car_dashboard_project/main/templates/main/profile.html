{% extends "main/base.html" %}
{% load static %}

{% block title %}Профиль{% endblock %}

{% block content %}

<!-- Кнопка создания объявления -->
<div class="mb-3 d-flex justify-content-between align-items-center">
    {% if request.user.id == profile_user.id %}
        <a href="{% url 'create_card' %}" class="btn btn-success">Создать объявление</a>
    {% endif %}
</div>

<div class="row">
    <!-- Левая колонка: информация о пользователе -->
    <div class="col-md-4">
        <div class="card bg-dark text-light border-secondary mb-3 p-3">
            <div class="text-center mb-3">
                {% if profile_user.profile_image and profile_user.profile_image.name %}
                    <img src="{{ profile_user.profile_image.url }}" alt="Фото профиля" class="img-thumbnail" style="max-width:120px;"
                        onerror="this.onerror=null;this.src='{% static 'img/default_user_img.png' %}'">
                {% else %}
                    <img src="{% static 'img/default_user_img.png' %}" alt="Фото профиля" class="img-thumbnail" style="max-width:120px;">
                {% endif %}
            </div>
            <p><strong>Тип пользователя:</strong> {{ profile_user.get_user_type_display }}</p>
            {% if profile_user.user_type == 'individual' %}
                <p><strong>Фамилия:</strong> {{ profile_user.last_name }}</p>
                <p><strong>Имя:</strong> {{ profile_user.first_name }}</p>
                <p><strong>Отчество:</strong> {{ profile_user.middle_name }}</p>
            {% elif profile_user.user_type == 'company' %}
                <p><strong>Компания:</strong> {{ profile_user.company_name }}</p>
            {% endif %}
            <p><strong>Телефон:</strong> {{ profile_user.phone }}</p>
            {% if request.user.id == profile_user.id %}
                <button id="edit-profile-btn" class="btn btn-primary mt-2 w-100">Изменить данные</button>
            {% endif %}
        </div>
    </div>

    <!-- Правая колонка: форма редактирования -->
    <div class="col-md-8">
        {% if request.user.id == profile_user.id %}
            <div class="card mb-4 bg-dark text-light border-secondary p-3" id="edit-profile-form" style="display:none;">
                <h5>Редактировать профиль</h5>
                <div class="mb-3">
                    <label for="user_type" class="form-label">Тип пользователя</label>
                    <select id="user_type" class="form-select">
                        <option value="">Выберите тип</option>
                        <option value="individual" {% if profile_user.user_type == 'individual' %}selected{% endif %}>Физическое лицо</option>
                        <option value="company" {% if profile_user.user_type == 'company' %}selected{% endif %}>Юридическое лицо</option>
                    </select>
                </div>

                <div id="individual_fields" style="display: {% if profile_user.user_type == 'individual' %}block{% else %}none{% endif %};">
                    <input type="text" id="first_name" value="{{ profile_user.first_name }}" class="form-control mb-2" placeholder="Имя">
                    <input type="text" id="last_name" value="{{ profile_user.last_name }}" class="form-control mb-2" placeholder="Фамилия">
                    <input type="text" id="middle_name" value="{{ profile_user.middle_name }}" class="form-control mb-2" placeholder="Отчество">
                </div>

                <div id="company_fields" style="display: {% if profile_user.user_type == 'company' %}block{% else %}none{% endif %};">
                    <input type="text" id="company_name" value="{{ profile_user.company_name }}" class="form-control mb-2" placeholder="Компания">
                </div>

                <input type="text" id="phone" value="{{ profile_user.phone }}" class="form-control mb-2" placeholder="Телефон">
                <input type="file" id="profile_image" class="form-control mb-2">

                <button id="save-profile-btn" class="btn btn-success">Сохранить профиль</button>
            </div>

                    {% endif %}
                </div>
            </div>

<!-- Карточки пользователя -->
<div class="row row-cols-1 row-cols-md-3 g-4 mt-3">
    {% for card in cards %}
    <div class="col">
        <div class="card h-100 bg-dark text-light border-secondary">
            {% if card.image %}
                <img src="{{ card.image.url }}" class="card-img-top" alt="{{ card.title }}">
            {% else %}
                <img src="{% static 'img/default_ad.png' %}" class="card-img-top" alt="Нет изображения">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ card.title }}</h5>
            </div>
            <div class="card-footer d-flex justify-content-between">
                {% if request.user.id == profile_user.id %}
                    <a href="{% url 'edit_card' card.id %}" class="btn btn-sm btn-outline-primary">✏️ Редактировать</a>
                    <a href="{% url 'delete_card' card.id %}" class="btn btn-sm btn-outline-danger">❌ Завершить</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p>Карточек пока нет.</p>
    {% endfor %}
</div>

<script>
const editBtn = document.getElementById('edit-profile-btn');
const editForm = document.getElementById('edit-profile-form');
const saveBtn = document.getElementById('save-profile-btn');

if (editBtn) {
    editBtn.addEventListener('click', () => {
        editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
    });
}

saveBtn.addEventListener('click', async () => {
    const formData = new FormData();
    formData.append('id', {{ profile_user.id }});
    formData.append('user_type', document.getElementById('user_type').value);
    formData.append('first_name', document.getElementById('first_name').value);
    formData.append('last_name', document.getElementById('last_name').value);
    formData.append('middle_name', document.getElementById('middle_name').value);
    formData.append('company_name', document.getElementById('company_name').value);
    formData.append('phone', document.getElementById('phone').value);

    const imageInput = document.getElementById('profile_image');
    if (imageInput.files.length > 0) formData.append('profile_image', imageInput.files[0]);

    const response = await fetch("{% url 'api_user_modify' %}", {
        method: "PUT",
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    });

    if (response.ok) {
        const data = await response.json();
        alert('Профиль обновлен!');
        location.reload();
    } else {
        const error = await response.json();
        alert('Ошибка: ' + JSON.stringify(error));
    }
});

// Показ/скрытие полей в зависимости от типа пользователя
const userTypeSelect = document.getElementById('user_type');
const individualFields = document.getElementById('individual_fields');
const companyFields = document.getElementById('company_fields');

userTypeSelect.addEventListener('change', function() {
    if (this.value === 'individual') {
        individualFields.style.display = 'block';
        companyFields.style.display = 'none';
    } else if (this.value === 'company') {
        individualFields.style.display = 'none';
        companyFields.style.display = 'block';
    } else {
        individualFields.style.display = 'none';
        companyFields.style.display = 'none';
    }
});
</script>
{% endblock %}