{% extends "main/base.html" %}
{% load static %}

{% block title %}Карточка{% endblock %}

{% block content %}
<!-- Заголовок объявления -->
<div class="row">
    <div class="col-12 mb-3">
        <h2>{{ card.title }}</h2>
    </div>
</div>

<!-- Фото и продавец -->
<div class="row">
    <!-- Фото объявления -->
    <div class="col-md-8">
        {% if card.image %}
            <img src="{{ card.image.url }}" class="ad-photo rounded shadow-sm" alt="{{ card.title }}">
        {% else %}
            <img src="{% static 'img/default_ad.png' %}" class="ad-photo rounded shadow-sm" alt="Нет изображения">
        {% endif %}
    </div>

    <!-- Карточка продавца -->
    <div class="col-md-4 d-flex align-items-start">
        <div class="card shadow-sm p-3 mb-3 w-100">
            <h4 class="mb-3">Продавец</h4>

            <span id="default-avatar" data-url="{% static 'profile_photos/default_user_img.png' %}" style="display:none;"></span>
            
            <div class="text-center mb-3">
                {% if seller.profile_image %}
                    <img src="{{ seller.profile_image.url }}" 
                         class="img-thumbnail seller-photo">
                {% else %}
                    <img src="{% static 'profile_photos/default_user_img.png' %}" 
                        class="rounded-circle" style="width:40px; height:40px; object-fit:cover;">
                {% endif %}
            </div>

            <div class="seller-info">
                {% if seller.user_type == 'individual' %}
                    <p class="fw-bold">{{ seller.first_name }} {{ seller.last_name }}</p>
                {% elif seller.user_type == 'company' %}
                    <p class="fw-bold">{{ seller.company_name }}</p>
                {% endif %}

                {% if seller.phone %}
                    <p><i class="bi bi-telephone"></i> {{ seller.phone }}</p>
                {% endif %}

                <p><i class="bi bi-calendar-check"></i> На сайте: {{ days_on_site }} дней</p>
                <p><i class="bi bi-star-fill text-warning"></i> Рейтинг: <span id="user-rating">0</span> ⭐</p>
            </div>

            <button id="reviews-btn" class="btn btn-primary w-100 mt-2">
                Отзывы
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно отзывов -->
<div class="modal fade" id="reviewsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Отзывы о {{ card.user.username }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Сначала форма для оставления отзыва -->
        <h6>Ваш отзыв</h6>
        <form id="review-form" class="mb-3">
            <div class="mb-2">
                <label for="rating">Рейтинг</label>
                <select id="rating" class="form-select" required
                    {% if request.user.role == 'admin' or request.user.role == 'analyst' %}disabled{% endif %}>
                    <option value="1">1 ⭐</option>
                    <option value="2">2 ⭐</option>
                    <option value="3">3 ⭐</option>
                    <option value="4">4 ⭐</option>
                    <option value="5">5 ⭐</option>
                </select>
            </div>
            <div class="mb-2">
                <label for="comment">Комментарий</label>
                <textarea id="comment" class="form-control" rows="3"
                    {% if request.user.role == 'admin' or request.user.role == 'analyst' %}disabled{% endif %}></textarea>
            </div>
            <button type="submit" class="btn btn-success"
                {% if request.user.role == 'admin' or request.user.role == 'analyst' %}disabled title="Вы не можете отправлять отзывы"{% endif %}>Отправить</button>
            <button type="button" id="delete-review" class="btn btn-danger"
                {% if request.user.role == 'admin' or request.user.role == 'analyst' %}disabled title="Вы не можете удалять отзывы"{% endif %}>Удалить отзыв</button>
        </form>

        <hr>

        <!-- Далее все отзывы -->
        <div id="reviews-list"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ====== CSRF ======
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// ====== Элементы ======
const userId = {{ card.user.id }};
const reviewsBtn = document.getElementById('reviews-btn');
const reviewsModal = new bootstrap.Modal(document.getElementById('reviewsModal'));
const reviewsList = document.getElementById('reviews-list');

{% if request.user.is_authenticated %}
const reviewForm = document.getElementById('review-form');
const deleteBtn = document.getElementById('delete-review');
const ratingEl = document.getElementById('rating');
const commentEl = document.getElementById('comment');
let currentReviewId = null;
const currentUserId = {{ request.user.id }};
{% endif %}

// ====== Загрузка отзывов с аватарками ======
async function fetchReviews() {
    try {
        const res = await fetch(`/api/users/${userId}/reviews/`);
        const data = await res.json();
        reviewsList.innerHTML = '';
        let total = 0;

        data.forEach(r => {
            total += r.rating;

            const avatar = r.reviewer_avatar || defaultAvatar;

            const div = document.createElement('div');
            div.classList.add('mb-3', 'd-flex', 'align-items-start', 'gap-2');

            div.innerHTML = `
                <img src="${avatar}" class="rounded-circle" style="width:40px; height:40px; object-fit:cover;">
                <div>
                    <strong>${r.reviewer_username}</strong> — ${r.rating} ⭐<br>
                    ${r.comment || ''}
                </div>
            `;
            reviewsList.appendChild(div);

            {% if request.user.is_authenticated %}
            if (r.reviewer === currentUserId) {
                currentReviewId = r.id;
                ratingEl.value = r.rating;
                commentEl.value = r.comment || '';
            }
            {% endif %}
        });

        const avgRating = data.length ? (total / data.length).toFixed(1) : 0;
        document.getElementById('user-rating').textContent = avgRating;

    } catch(err) {
        console.error(err);
        reviewsList.innerHTML = '<p class="text-danger">Не удалось загрузить отзывы.</p>';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchReviews();
});

reviewsBtn.addEventListener('click', () => {
    reviewsModal.show();
    fetchReviews();
});

{% if request.user.is_authenticated %}
// ====== Отправка / обновление / удаление отзыва ======
reviewForm.addEventListener('submit', async e => {
    e.preventDefault();
    const method = currentReviewId ? 'PUT' : 'POST';
    const url = `/api/users/${userId}/review/`;
    try {
        const res = await fetch(url, {
            method,
            headers: {
                'Content-Type':'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                rating: parseInt(ratingEl.value),
                comment: commentEl.value
            }),
            credentials: 'same-origin'
        });
        if (res.ok) {
            fetchReviews();
        } else {
            alert('Ошибка при отправке отзыва');
        }
    } catch(err) {
        console.error(err);
    }
});

deleteBtn.addEventListener('click', async () => {
    if (!currentReviewId) return;
    try {
        const res = await fetch(`/api/users/${userId}/review/`, {
            method:'DELETE',
            headers: {'X-CSRFToken': csrftoken},
            credentials: 'same-origin'
        });
        if (res.ok) {
            ratingEl.value = 1;
            commentEl.value = '';
            currentReviewId = null;
            fetchReviews();
        }
    } catch(err) {
        console.error(err);
    }
});
{% endif %}
</script>
{% endblock %}